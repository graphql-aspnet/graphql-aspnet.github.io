"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[2892],{883:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"development/entity-framework","title":"Using Entity Framework","description":"DbContext and Parallel Query Operations","source":"@site/docs/development/entity-framework.md","sourceDirName":"development","slug":"/development/entity-framework","permalink":"/docs/development/entity-framework","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"id":"entity-framework","title":"Using Entity Framework","sidebar_label":"Entity Framework","sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"Unit Testing","permalink":"/docs/development/unit-testing"},"next":{"title":"File Uploads & Batching","permalink":"/docs/server-extensions/multipart-requests"}}');var i=n(4848),r=n(8453);const s={id:"entity-framework",title:"Using Entity Framework",sidebar_label:"Entity Framework",sidebar_position:2},a=void 0,l={},c=[{value:"DbContext and Parallel Query Operations",id:"dbcontext-and-parallel-query-operations",level:2},{value:"Register DbContext as Transient",id:"register-dbcontext-as-transient",level:3},{value:"Execute Controller Actions in Isolation",id:"execute-controller-actions-in-isolation",level:3}];function d(e){const t={code:"code",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.h2,{id:"dbcontext-and-parallel-query-operations",children:"DbContext and Parallel Query Operations"}),"\n",(0,i.jsxs)(t.p,{children:["In a standard REST application we would register our ",(0,i.jsx)(t.code,{children:"DbContext"})," like so:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-csharp",metastring:'title="Adding Entity Framework at Startup"',children:'// highlight-next-line\nservices.AddDbContext<AppDbContext>(o =>\n{\n    o.UseSqlServer("<connectionString>");\n});\n'})}),"\n",(0,i.jsxs)(t.p,{children:["This default registration adds the ",(0,i.jsx)(t.code,{children:"DbContext"})," to the DI container is as a ",(0,i.jsx)(t.code,{children:"Scoped"})," service. Meaning one instance is generated per Http request. However, consider the following graph controller and query:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-csharp",metastring:'title="FoodController.cs"',children:"public class FoodController : GraphController\n{    \n    private AppDbContext _context;\n    public FoodController(AppDbContext context){/**/}\n\n    [QueryRoot]\n    // highlight-next-line\n    public IFood SearchMeat(string name){/**/}\n\n    [QueryRoot]\n    // highlight-next-line\n    public IFood SearchVeggies(string name){/**/}\n}\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-graphql",metastring:'title="Sample Query"',children:'query {\n    # highlight-next-line\n    searchMeat(name: "steak*") {\n        name\n    }\n    # highlight-next-line\n    searchVeggies(name: "green*") {\n        name\n    }\n}\n'})}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"FoodController"})," contains two action methods both of which are requested. Since this is a query and not a mutation, both top-level action methods are executed in parallel. This can result in an exception being thrown:"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"Ef Core Error",src:n(2634).A+"",width:"1350",height:"575"})}),"\n",(0,i.jsx)(t.p,{children:"This is caused by graphql attempting to execute both controller actions simultaneously. EF Core will reject multiple active queries. There are a few ways to address this and each comes with its own trade offs:"}),"\n",(0,i.jsx)(t.h3,{id:"register-dbcontext-as-transient",children:"Register DbContext as Transient"}),"\n",(0,i.jsx)(t.p,{children:"One way to correct this problem is to register your DbContext as a transient object."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-csharp",metastring:'title="Option 1: Register DbContext as Transient"',children:'services.AddDbContext<AppDbContext>(\n    options =>\n    {\n        options.UseSqlServer("<connectionString>");\n    },\n    // highlight-next-line\n     ServiceLifetime.Transient);\n'})}),"\n",(0,i.jsx)(t.p,{children:"Now each invocation will get its own DbContext and the queries can execute in parallel without issue."}),"\n",(0,i.jsx)(t.p,{children:"The tradeoff here is that you lose the singular scoped unit-of-work for the whole request granted by a shared context."}),"\n",(0,i.jsxs)(t.p,{children:["If you have services registered to the DI container that make use of the DbContext you would want to register them as ",(0,i.jsx)(t.code,{children:"Transient"})," as well lest one scoped service be created for the request trapping a single DbContext instance. Sometimes, however; this is unavoidable, especially with legacy code..."]}),"\n",(0,i.jsx)(t.h3,{id:"execute-controller-actions-in-isolation",children:"Execute Controller Actions in Isolation"}),"\n",(0,i.jsx)(t.p,{children:"Another option is to instruct graphql to execute its controller actions in sequence, rather than in parallel."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-csharp",metastring:'title="Option 2: Isolate GraphQL Controller Actions"',children:"services.AddGraphQL(o =>\n{\n    // highlight-next-line\n    o.ExecutionOptions.ResolverIsolation = ResolverIsolationOptions.ControllerActions;\n});\n"})}),"\n",(0,i.jsxs)(t.p,{children:["This will instruct graphql to execute each encountered controller action one after the other. Your scoped ",(0,i.jsx)(t.code,{children:"DbContext"})," would then be able to process the queries without issue."]}),"\n",(0,i.jsx)(t.p,{children:"The tradeoff with this method is a slight increase in processing time since the methods are called in sequence. All other field resolutions would be executed in parallel."}),"\n",(0,i.jsx)(t.p,{children:"If your application has other resources or services that may have similar restrictions, it can be beneficial to isolate the other resolver types as well. You can add them to the ResolverIsolation configuration option as needed."})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},2634:(e,t,n)=>{n.d(t,{A:()=>o});const o=n.p+"assets/images/ef-core-error-25cba617d4749a01fdb960bac7d221fb.png"},8453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>a});var o=n(6540);const i={},r=o.createContext(i);function s(e){const t=o.useContext(r);return o.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),o.createElement(r.Provider,{value:t},e.children)}}}]);