"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[2692],{1014:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"development/unit-testing","title":"Unit Testing","description":".NET 8+","source":"@site/docs/development/unit-testing.md","sourceDirName":"development","slug":"/development/unit-testing","permalink":"/docs/development/unit-testing","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"id":"unit-testing","title":"Unit Testing","sidebar_label":"Unit Testing","sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"Debugging","permalink":"/docs/development/debugging"},"next":{"title":"Entity Framework","permalink":"/docs/development/entity-framework"}}');var s=t(4848),i=t(8453);const o={id:"unit-testing",title:"Unit Testing",sidebar_label:"Unit Testing",sidebar_position:1},l=void 0,a={},d=[{value:"Install the Framework",id:"install-the-framework",level:2},{value:"Create a Test Server",id:"create-a-test-server",level:2},{value:"Execute a Query",id:"execute-a-query",level:2},{value:"Other Test Scenarios",id:"other-test-scenarios",level:2},{value:"Throwing Exceptions",id:"throwing-exceptions",level:3},{value:"Authn &amp; Authz",id:"authn--authz",level:3},{value:"Demo project",id:"demo-project",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("span",{className:"pill",children:".NET 8+"}),"\n",(0,s.jsx)("br",{}),"\n",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsx)(n.p,{children:"Your test projects must target .NET 8 or greater to use the test framework"})}),"\n",(0,s.jsxs)(n.p,{children:["GraphQL ASP.NET has more than ",(0,s.jsx)(n.code,{children:"3500 unit tests and 91% code coverage"}),". All the internal integration tests are powered by a framework designed to quickly build a configurable, fully mocked server instance to perform a query against the runtime. It may be helpful to use and extend the framework to test your own controllers."]}),"\n",(0,s.jsx)(n.p,{children:"This document explains how to perform some common test functions for your own controller methods."}),"\n",(0,s.jsx)(n.h2,{id:"install-the-framework",children:"Install the Framework"}),"\n",(0,s.jsxs)(n.p,{children:["Add a reference to the ",(0,s.jsx)(n.a,{href:"https://www.nuget.org/packages/GraphQL.AspNet.TestFramework",children:"Nuget Package"})," ",(0,s.jsx)(n.code,{children:"GraphQL.AspNet.TestFramework"})," to your unit test project. The framework is just a class library and not dependent on any individual testing framework like NUnit or XUnit. However, it does mock some runtime only objects and, as a result, is dependent on ",(0,s.jsx)(n.a,{href:"https://www.nuget.org/packages/Moq",children:"Moq"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-powershell",metastring:'title="Install the Test Framework"',children:"# Using the dotnet CLI\n> dotnet add package GraphQL.AspNet.TestFramework\n\n# Using Package Manager Console\n> Install-Package GraphQL.AspNet.TestFramework\n"})}),"\n",(0,s.jsx)(n.h2,{id:"create-a-test-server",children:"Create a Test Server"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Create a new instance of the ",(0,s.jsx)(n.code,{children:"TestServerBuilder"}),". The builder takes in an optional set of flags to perform some auto configurations for common scenarios such as exposing exceptions or altering the casing of graph type names."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Configure your test scenario"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Use ",(0,s.jsx)(n.code,{children:".User"})," to add any permissions to the mocked user account"]}),"\n",(0,s.jsxs)(n.li,{children:["Use ",(0,s.jsx)(n.code,{children:".Authorization"})," to add any security policy definitions if you wish to test security"]}),"\n",(0,s.jsxs)(n.li,{children:["Use ",(0,s.jsx)(n.code,{children:".AddGraphQL()"})," to mimic the functionality of schema configuration used when your application starts."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"TestServerBuilder"})," implements ",(0,s.jsx)(n.code,{children:"IServiceCollection"}),". Add any additional mocked services as needed to ensure your controllers are wired up correctly by the runtime."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Build the server instance using ",(0,s.jsx)(n.code,{children:".Build()"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",metastring:'title="Configuring a Test Server Instance"',children:"[Test]\npublic async Task MyController_InvocationTest()\n{\n    // Arrange\n    var builder = new TestServerBuilder();\n    builder.AddGraphQL(o => {\n        o.AddController<MyController>();\n    });\n\n    // Act\n    var server = builder.Build();\n\n    // continued...\n}\n\n"})}),"\n",(0,s.jsx)(n.admonition,{title:"Custom Schemas",type:"tip",children:(0,s.jsxs)(n.p,{children:["Use ",(0,s.jsx)(n.code,{children:"TestServerBuild<TSchema>"})," to test against a custom defined schema instance."]})}),"\n",(0,s.jsx)(n.h2,{id:"execute-a-query",children:"Execute a Query"}),"\n",(0,s.jsx)(n.p,{children:"Follow these steps to execute a query against the runtime. If your controller is registered to the test server and the appropriate field is requested in the query, it will be invoked."}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Create a builder to generate a mocked execution context (the object that the runtime acts on) using ",(0,s.jsx)(n.code,{children:".CreateQueryContextBuilder()"})]}),"\n",(0,s.jsx)(n.li,{children:"Configure the query text, variables etc. on the builder."}),"\n",(0,s.jsxs)(n.li,{children:["Build the context and submit it for processing:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Use ",(0,s.jsx)(n.code,{children:"server.ExecuteQuery()"})," to process the context. ",(0,s.jsx)(n.code,{children:"context.Result"})," will be filled with the final ",(0,s.jsx)(n.code,{children:"IQueryExecutionResult"})," which can be inspected for resultant data fields and error messages."]}),"\n",(0,s.jsxs)(n.li,{children:["Use ",(0,s.jsx)(n.code,{children:"server.RenderResult()"})," to generate the json string a client would recieve if they performed the query."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",metastring:'title="Executing a Test Query"',children:'[Test]\npublic async Task MyController_InvocationTest()\n{    \n    // Arrange\n    var builder = new TestServerBuilder();\n    builder.AddGraphQL(o => {\n        o.AddController<MyController>();\n    });\n\n    var server = builder.Build();\n    var queryBuilder = server.CreateQueryContextBuilder();\n    queryBuilder.AddQueryText("query { controller { actionMethod { property1 } } }");\n\n    var queryContext = queryBuilder.Build();\n\n    // Act\n    var result = await server.RenderResult(queryContext);\n\n    /* result contains the string for:\n    {\n        "data" : {\n            "controller": {\n                "actionMethod" : {\n                    "property1" : "value1"\n                }\n            }\n        }\n    }\n    */\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"other-test-scenarios",children:"Other Test Scenarios"}),"\n",(0,s.jsx)(n.h3,{id:"throwing-exceptions",children:"Throwing Exceptions"}),"\n",(0,s.jsx)(n.p,{children:"If you need to test that your controller throws an appropriate exception you can inspect the response object (instead of rendering a result). The exception will be attached to an error message generated during the query execution."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",metastring:'title="Testing for Thrown Exceptions"',children:'[Test]\npublic async Task MyController_InvocationTest()\n{    \n    // Arrange\n    var builder = new TestServerBuilder();\n    builder.AddGraphQL(o => {\n        o.AddController<MyController>();\n    });\n\n    var server = builder.Build();\n    var queryBuilder = server.CreateQueryContextBuilder();\n    queryBuilder.AddQueryText("query { controller { actionMethod { property1 } } }");\n\n    var queryContext = queryBuilder.Build();\n\n    // Act\n    // Use ExecuteQuery instead of RenderResult to obtain the response object\n    // highlight-next-line\n    var result = await server.ExecuteQuery(queryContext);\n\n    // Assert\n    // ensure a message was captured\n    Assert.IsNotNull(result);    \n    Assert.AreEqual(1, result.Messages.Count);\n    Assert.IsInstanceOf(typeof(MyException), result.Messages[0].Exception);\n}\n'})}),"\n",(0,s.jsxs)(n.admonition,{type:"tip",children:[(0,s.jsx)(n.mdxAdmonitionTitle,{}),(0,s.jsxs)(n.p,{children:["Use ",(0,s.jsx)(n.code,{children:"server.ExecuteQuery"})," to obtain a reference to the response object. This allows you to interrogate the message data before its rendered as a json document."]})]}),"\n",(0,s.jsx)(n.h3,{id:"authn--authz",children:"Authn & Authz"}),"\n",(0,s.jsx)(n.p,{children:"Test authentication and authorization scenarios by configuring both the policies the server should support and the claims or roles the user will present during the test."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",children:'[Test]\npublic async Task WhenUserHasPolicy_ThenAllowExecution()\n{    \n    // Arrange\n    var builder = new TestServerBuilder();\n    builder.AddGraphQL(o => {\n        o.AddController<MyController>();\n    });\n\n    // configure the policies the server will recognize\n    // and the claims the user context will have.\n    // This specific test assumes that the controller method \n    // defines an authorization requirement of "policy1".\n    // highlight-start\n    builder.Authorization.AddClaimPolicy("policy1", "myClaimType", "myClaimValue");\n    builder.UserContext.AddUserClaim("myClaimType", "myClaimValue")\n    // highlight-end\n\n    var server = builder.Build();\n    var queryBuilder = server.CreateQueryContextBuilder();\n    queryBuilder.AddQueryText("query { controller { actionMethod { property1 } } }");\n\n    var queryContext = queryBuilder.Build();\n\n    // Act\n    var result = await server.RenderResult(queryContext);\n\n    // Assert\n    // ....\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"The user context is always injected when you run a query on the test server. By default it is an anonymous user and credentials are applied when you add a claim or policy to the context during setup."}),"\n",(0,s.jsx)(n.h2,{id:"demo-project",children:"Demo project"}),"\n",(0,s.jsxs)(n.p,{children:["See the ",(0,s.jsx)(n.a,{href:"/docs/reference/demo-projects",children:"demos page"})," for a working demo using XUnit."]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>l});var r=t(6540);const s={},i=r.createContext(s);function o(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);