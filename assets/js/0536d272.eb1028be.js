"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[2692],{5680:(e,t,n)=>{n.d(t,{xA:()=>d,yg:()=>g});var r=n(6540);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),u=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=u(e.components);return r.createElement(s.Provider,{value:t},e.children)},c="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},y=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),c=u(n),y=a,g=c["".concat(s,".").concat(y)]||c[y]||p[y]||o;return n?r.createElement(g,i(i({ref:t},d),{},{components:n})):r.createElement(g,i({ref:t},d))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=y;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[c]="string"==typeof e?e:a,i[1]=l;for(var u=2;u<o;u++)i[u]=n[u];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}y.displayName="MDXCreateElement"},6765:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>c,frontMatter:()=>o,metadata:()=>l,toc:()=>u});var r=n(8168),a=(n(6540),n(5680));const o={id:"unit-testing",title:"Unit Testing",sidebar_label:"Unit Testing",sidebar_position:1},i=void 0,l={unversionedId:"development/unit-testing",id:"development/unit-testing",title:"Unit Testing",description:".NET 6+",source:"@site/docs/development/unit-testing.md",sourceDirName:"development",slug:"/development/unit-testing",permalink:"/docs/development/unit-testing",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{id:"unit-testing",title:"Unit Testing",sidebar_label:"Unit Testing",sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Debugging",permalink:"/docs/development/debugging"},next:{title:"Entity Framework",permalink:"/docs/development/entity-framework"}},s={},u=[{value:"Install the Framework",id:"install-the-framework",level:2},{value:"Create a Test Server",id:"create-a-test-server",level:2},{value:"Execute a Query",id:"execute-a-query",level:2},{value:"Other Test Scenarios",id:"other-test-scenarios",level:2},{value:"Throwing Exceptions",id:"throwing-exceptions",level:3},{value:"Authn &amp; Authz",id:"authn--authz",level:3},{value:"Demo project",id:"demo-project",level:2}],d={toc:u};function c(e){let{components:t,...n}=e;return(0,a.yg)("wrapper",(0,r.A)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.yg)("span",{className:"pill"},".NET 6+"),(0,a.yg)("br",null),(0,a.yg)("br",null),(0,a.yg)("admonition",{type:"info"},(0,a.yg)("p",{parentName:"admonition"},"Your test projects must target .NET 6 or greater to use the test framework")),(0,a.yg)("p",null,"GraphQL ASP.NET has more than ",(0,a.yg)("inlineCode",{parentName:"p"},"3500 unit tests and 91% code coverage"),". All the internal integration tests are powered by a framework designed to quickly build a configurable, fully mocked server instance to perform a query against the runtime. It may be helpful to use and extend the framework to test your own controllers."),(0,a.yg)("p",null,"This document explains how to perform some common test functions for your own controller methods."),(0,a.yg)("h2",{id:"install-the-framework"},"Install the Framework"),(0,a.yg)("p",null,"Add a reference to the ",(0,a.yg)("a",{parentName:"p",href:"https://www.nuget.org/packages/GraphQL.AspNet.TestFramework"},"Nuget Package")," ",(0,a.yg)("inlineCode",{parentName:"p"},"GraphQL.AspNet.TestFramework")," to your unit test project. The framework is just a class library and not dependent on any individual testing framework like NUnit or XUnit. However, it does mock some runtime only objects and, as a result, is dependent on ",(0,a.yg)("a",{parentName:"p",href:"https://www.nuget.org/packages/Moq"},"Moq"),"."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-powershell",metastring:'title="Install the Test Framework"',title:'"Install',the:!0,Test:!0,'Framework"':!0},"# Using the dotnet CLI\n> dotnet add package GraphQL.AspNet.TestFramework\n\n# Using Package Manager Console\n> Install-Package GraphQL.AspNet.TestFramework\n")),(0,a.yg)("h2",{id:"create-a-test-server"},"Create a Test Server"),(0,a.yg)("ol",null,(0,a.yg)("li",{parentName:"ol"},(0,a.yg)("p",{parentName:"li"},"Create a new instance of the ",(0,a.yg)("inlineCode",{parentName:"p"},"TestServerBuilder"),". The builder takes in an optional set of flags to perform some auto configurations for common scenarios such as exposing exceptions or altering the casing of graph type names.")),(0,a.yg)("li",{parentName:"ol"},(0,a.yg)("p",{parentName:"li"},"Configure your test scenario"),(0,a.yg)("ul",{parentName:"li"},(0,a.yg)("li",{parentName:"ul"},"Use ",(0,a.yg)("inlineCode",{parentName:"li"},".User")," to add any permissions to the mocked user account"),(0,a.yg)("li",{parentName:"ul"},"Use ",(0,a.yg)("inlineCode",{parentName:"li"},".Authorization")," to add any security policy definitions if you wish to test security"),(0,a.yg)("li",{parentName:"ul"},"Use ",(0,a.yg)("inlineCode",{parentName:"li"},".AddGraphQL()")," to mimic the functionality of schema configuration used when your application starts."),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"TestServerBuilder")," implements ",(0,a.yg)("inlineCode",{parentName:"li"},"IServiceCollection"),". Add any additional mocked services as needed to ensure your controllers are wired up correctly by the runtime."))),(0,a.yg)("li",{parentName:"ol"},(0,a.yg)("p",{parentName:"li"},"Build the server instance using ",(0,a.yg)("inlineCode",{parentName:"p"},".Build()")))),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-csharp",metastring:'title="Configuring a Test Server Instance"',title:'"Configuring',a:!0,Test:!0,Server:!0,'Instance"':!0},"[Test]\npublic async Task MyController_InvocationTest()\n{\n    // Arrange\n    var builder = new TestServerBuilder();\n    builder.AddGraphQL(o => {\n        o.AddController<MyController>();\n    });\n\n    // Act\n    var server = builder.Build();\n\n    // continued...\n}\n\n")),(0,a.yg)("admonition",{title:"Custom Schemas",type:"tip"},(0,a.yg)("p",{parentName:"admonition"},"Use ",(0,a.yg)("inlineCode",{parentName:"p"},"TestServerBuild<TSchema>")," to test against a custom defined schema instance.")),(0,a.yg)("h2",{id:"execute-a-query"},"Execute a Query"),(0,a.yg)("p",null,"Follow these steps to execute a query against the runtime. If your controller is registered to the test server and the appropriate field is requested in the query, it will be invoked."),(0,a.yg)("ol",null,(0,a.yg)("li",{parentName:"ol"},"Create a builder to generate a mocked execution context (the object that the runtime acts on) using ",(0,a.yg)("inlineCode",{parentName:"li"},".CreateQueryContextBuilder()")),(0,a.yg)("li",{parentName:"ol"},"Configure the query text, variables etc. on the builder."),(0,a.yg)("li",{parentName:"ol"},"Build the context and submit it for processing:",(0,a.yg)("ul",{parentName:"li"},(0,a.yg)("li",{parentName:"ul"},"Use ",(0,a.yg)("inlineCode",{parentName:"li"},"server.ExecuteQuery()")," to process the context. ",(0,a.yg)("inlineCode",{parentName:"li"},"context.Result")," will be filled with the final ",(0,a.yg)("inlineCode",{parentName:"li"},"IQueryExecutionResult")," which can be inspected for resultant data fields and error messages."),(0,a.yg)("li",{parentName:"ul"},"Use ",(0,a.yg)("inlineCode",{parentName:"li"},"server.RenderResult()")," to generate the json string a client would recieve if they performed the query.")))),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-csharp",metastring:'title="Executing a Test Query"',title:'"Executing',a:!0,Test:!0,'Query"':!0},'[Test]\npublic async Task MyController_InvocationTest()\n{    \n    // Arrange\n    var builder = new TestServerBuilder();\n    builder.AddGraphQL(o => {\n        o.AddController<MyController>();\n    });\n\n    var server = builder.Build();\n    var queryBuilder = server.CreateQueryContextBuilder();\n    queryBuilder.AddQueryText("query { controller { actionMethod { property1 } } }");\n\n    var queryContext = queryBuilder.Build();\n\n    // Act\n    var result = await server.RenderResult(queryContext);\n\n    /* result contains the string for:\n    {\n        "data" : {\n            "controller": {\n                "actionMethod" : {\n                    "property1" : "value1"\n                }\n            }\n        }\n    }\n    */\n}\n')),(0,a.yg)("h2",{id:"other-test-scenarios"},"Other Test Scenarios"),(0,a.yg)("h3",{id:"throwing-exceptions"},"Throwing Exceptions"),(0,a.yg)("p",null,"If you need to test that your controller throws an appropriate exception you can inspect the response object (instead of rendering a result). The exception will be attached to an error message generated during the query execution."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-csharp",metastring:'title="Testing for Thrown Exceptions"',title:'"Testing',for:!0,Thrown:!0,'Exceptions"':!0},'[Test]\npublic async Task MyController_InvocationTest()\n{    \n    // Arrange\n    var builder = new TestServerBuilder();\n    builder.AddGraphQL(o => {\n        o.AddController<MyController>();\n    });\n\n    var server = builder.Build();\n    var queryBuilder = server.CreateQueryContextBuilder();\n    queryBuilder.AddQueryText("query { controller { actionMethod { property1 } } }");\n\n    var queryContext = queryBuilder.Build();\n\n    // Act\n    // Use ExecuteQuery instead of RenderResult to obtain the response object\n    // highlight-next-line\n    var result = await server.ExecuteQuery(queryContext);\n\n    // Assert\n    // ensure a message was captured\n    Assert.IsNotNull(result);    \n    Assert.AreEqual(1, result.Messages.Count);\n    Assert.IsInstanceOf(typeof(MyException), result.Messages[0].Exception);\n}\n')),(0,a.yg)("admonition",{type:"tip"},(0,a.yg)("p",{parentName:"admonition"},"Use ",(0,a.yg)("inlineCode",{parentName:"p"},"server.ExecuteQuery")," to obtain a reference to the response object. This allows you to interrogate the message data before its rendered as a json document.")),(0,a.yg)("h3",{id:"authn--authz"},"Authn & Authz"),(0,a.yg)("p",null,"Test authentication and authorization scenarios by configuring both the policies the server should support and the claims or roles the user will present during the test."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-csharp"},'[Test]\npublic async Task WhenUserHasPolicy_ThenAllowExecution()\n{    \n    // Arrange\n    var builder = new TestServerBuilder();\n    builder.AddGraphQL(o => {\n        o.AddController<MyController>();\n    });\n\n    // configure the policies the server will recognize\n    // and the claims the user context will have.\n    // This specific test assumes that the controller method \n    // defines an authorization requirement of "policy1".\n    // highlight-start\n    builder.Authorization.AddClaimPolicy("policy1", "myClaimType", "myClaimValue");\n    builder.UserContext.AddUserClaim("myClaimType", "myClaimValue")\n    // highlight-end\n\n    var server = builder.Build();\n    var queryBuilder = server.CreateQueryContextBuilder();\n    queryBuilder.AddQueryText("query { controller { actionMethod { property1 } } }");\n\n    var queryContext = queryBuilder.Build();\n\n    // Act\n    var result = await server.RenderResult(queryContext);\n\n    // Assert\n    // ....\n}\n')),(0,a.yg)("p",null,"The user context is always injected when you run a query on the test server. By default it is an anonymous user and credentials are applied when you add a claim or policy to the context during setup. "),(0,a.yg)("h2",{id:"demo-project"},"Demo project"),(0,a.yg)("p",null,"See the ",(0,a.yg)("a",{parentName:"p",href:"/docs/reference/demo-projects"},"demos page")," for a working demo using XUnit."))}c.isMDXComponent=!0}}]);